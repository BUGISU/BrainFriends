"use client";

import React, { useState, useEffect, useMemo, useRef, Suspense } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { loadPatientProfile } from "@/lib/patientStorage";
import { PlaceType } from "@/constants/trainingData";
import { FLUENCY_SCENARIOS } from "@/constants/fluencyData";
import {
  calculateKWABScores,
  getAQNormalComparison,
  scoreContentDelivery,
  scoreFluency,
} from "@/lib/kwab/KWABScoring";
import { SessionManager, TrainingHistoryEntry } from "@/lib/kwab/SessionManager";
import { addSentenceLineBreaks } from "@/lib/text/displayText";

function getResultSummarySizeClass(text: string): string {
  const normalizedLength = (text || "").replace(/\s+/g, "").length;
  if (normalizedLength >= 56) return "text-sm md:text-base";
  if (normalizedLength >= 36) return "text-base md:text-lg";
  return "text-lg md:text-xl";
}

// --- 데이터 타입 및 유틸리티 로직 (보존) ---
type ExportFile = { name: string; data: Uint8Array };
type DerivedKwab = {
  evidence: Array<any>;
  spontaneousSpeech: {
    contentScore: number;
    fluencyScore: number;
    total: number;
  };
  auditoryComprehension: {
    yesNoScore: number;
    wordRecognitionScore: number;
    commandScore: number;
    total: number;
  };
  repetition: { totalScore: number };
  naming: {
    objectNamingScore: number;
    wordFluencyScore: number;
    sentenceCompletionScore: number;
    sentenceResponseScore: number;
    total: number;
  };
  contentScore: number;
  fluencyScore: number;
  spontaneousTotal: number;
  aq: number;
  lq: number;
  cq: number;
  aphasiaType: string | null;
  classificationBasis: {
    fluency: number;
    comprehension: number;
    repetition: number;
    naming: number;
  };
  classificationReason: string;
  severity: string;
  percentile: number;
};

// ZIP 생성 관련 유틸리티 (보존)
function makeCrc32Table() {
  const table = new Uint32Array(256);
  for (let i = 0; i < 256; i++) {
    let c = i;
    for (let j = 0; j < 8; j++) c = c & 1 ? 0xedb88320 ^ (c >>> 1) : c >>> 1;
    table[i] = c >>> 0;
  }
  return table;
}
const CRC32_TABLE = makeCrc32Table();
function crc32(data: Uint8Array) {
  let crc = 0xffffffff;
  for (let i = 0; i < data.length; i++)
    crc = (CRC32_TABLE[(crc ^ data[i]) & 0xff] ^ (crc >>> 8)) >>> 0;
  return (crc ^ 0xffffffff) >>> 0;
}
function concatUint8Arrays(chunks: Uint8Array[]) {
  const total = chunks.reduce((sum, c) => sum + c.length, 0);
  const out = new Uint8Array(total);
  let offset = 0;
  for (const c of chunks) {
    out.set(c, offset);
    offset += c.length;
  }
  return out;
}
function dataUrlToBytes(dataUrl: string) {
  const match = dataUrl.match(/^data:([^;]+);base64,(.+)$/);
  if (!match)
    return { bytes: new Uint8Array(), mime: "application/octet-stream" };
  const mime = match[1];
  const binary = atob(match[2]);
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
  return { bytes, mime };
}
function createZipBlob(files: ExportFile[]) {
  const localChunks: Uint8Array[] = [];
  const centralChunks: Uint8Array[] = [];
  let offset = 0;
  for (const file of files) {
    const nameBytes = new TextEncoder().encode(file.name);
    const crc = crc32(file.data);
    const size = file.data.length;
    const localHeader = new Uint8Array(30 + nameBytes.length);
    const localView = new DataView(localHeader.buffer);
    localView.setUint32(0, 0x04034b50, true);
    localView.setUint32(14, crc, true);
    localView.setUint32(18, size, true);
    localView.setUint32(22, size, true);
    localView.setUint16(26, nameBytes.length, true);
    localHeader.set(nameBytes, 30);
    localChunks.push(localHeader, file.data);
    const centralHeader = new Uint8Array(46 + nameBytes.length);
    const centralView = new DataView(centralHeader.buffer);
    centralView.setUint32(0, 0x02014b50, true);
    centralView.setUint32(16, crc, true);
    centralView.setUint32(20, size, true);
    centralView.setUint32(24, size, true);
    centralView.setUint16(28, nameBytes.length, true);
    centralView.setUint32(42, offset, true);
    centralHeader.set(nameBytes, 46);
    centralChunks.push(centralHeader);
    offset += localHeader.length + file.data.length;
  }
  const centralSize = centralChunks.reduce((sum, c) => sum + c.length, 0);
  const end = new Uint8Array(22);
  const endView = new DataView(end.buffer);
  endView.setUint32(0, 0x06054b50, true);
  endView.setUint16(8, files.length, true);
  endView.setUint16(10, files.length, true);
  endView.setUint32(12, centralSize, true);
  endView.setUint32(16, offset, true);
  return new Blob(
    [concatUint8Arrays([...localChunks, ...centralChunks, end])],
    { type: "application/zip" },
  );
}

function ResultContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [isMounted, setIsMounted] = useState(false);
  const [playingIndex, setPlayingIndex] = useState<string | null>(null);
  const [openStepId, setOpenStepId] = useState<number | null>(1);
  const [openAllAccordions, setOpenAllAccordions] = useState(false);
  const audioRef = useRef<HTMLAudioElement | null>(null);
  const [sessionData, setSessionData] = useState<any>(null);
  const [historyRefreshKey, setHistoryRefreshKey] = useState(0);
  const [selectedHistory, setSelectedHistory] = useState<TrainingHistoryEntry | null>(
    null,
  );
  const [historyPage, setHistoryPage] = useState(1);

  const place = useMemo(
    () => (searchParams.get("place") as PlaceType) || "home",
    [searchParams],
  );
  const patientProfile = useMemo(() => loadPatientProfile(), []);
  const patientForHistory = useMemo(() => {
    if (!patientProfile) return null;
    return {
      age: Number((patientProfile as any).age ?? 0),
      educationYears: Number((patientProfile as any).educationYears ?? 0),
      ...(patientProfile as any),
    } as any;
  }, [patientProfile]);

  // --- 기존 연산 로직 (보존) ---
  const queryScores = useMemo(
    () => ({
      1: Number(searchParams.get("step1") || 0),
      2: Number(searchParams.get("step2") || 0),
      3: Number(searchParams.get("step3") || 0),
      4: Number(searchParams.get("step4") || 0),
      5: Number(searchParams.get("step5") || 0),
      6: Number(searchParams.get("step6") || 0),
    }),
    [searchParams],
  );

  const deriveSpontaneousSpeechFromStep4 = (items: any[]) => {
    if (!items.length) {
      return { contentScore: 8, fluencyScore: 8 };
    }

    const normalize = (v: string) => v.toLowerCase().replace(/\s+/g, "");
    const scenarios = FLUENCY_SCENARIOS[place] || [];

    const itemAnalyses = items.map((item: any) => {
      const transcript = String(
        item?.transcript || item?.text || item?.targetText || "",
      );
      const normalizedTranscript = normalize(transcript);

      const matchedScenario =
        scenarios.find(
          (s) =>
            s.prompt === item?.prompt ||
            s.situation === item?.situation ||
            s.situation === item?.text,
        ) || null;
      const keywords = matchedScenario?.answerKeywords || [];

      const uniqueHits = keywords.filter((kw, idx) => {
        if (!kw) return false;
        if (keywords.indexOf(kw) !== idx) return false;
        return normalizedTranscript.includes(normalize(kw));
      }).length;
      const keywordCoverage = keywords.length ? uniqueHits / keywords.length : 0;

      const sentenceParts = transcript
        .split(/[.!?\n]+/)
        .map((s) => s.trim())
        .filter(Boolean);
      const utteranceCount = Math.max(1, sentenceParts.length);
      const hangulChars = (transcript.match(/[가-힣]/g) || []).length;
      const syllablesPerUtterance = hangulChars / utteranceCount;
      const hasCompleteSentences =
        sentenceParts.some((s) => s.length >= 12) ||
        /[다요니다]\s*$/.test(transcript);
      const hasWordFindingDifficulty =
        /(음|어|저기|그게|그거|...|…)/.test(transcript);
      const speechDurationSec = Number(item?.speechDuration || 0);
      const charsPerSec =
        speechDurationSec > 0 ? transcript.length / speechDurationSec : 0;
      const speechRate =
        charsPerSec >= 3 ? "normal" : charsPerSec >= 1.5 ? "slow" : "very_slow";

      return {
        uniqueHits,
        keywordCoverage,
        fluencyKwab:
          Number(item?.fluencyScore ?? item?.kwabScore) ||
          scoreFluency({
            syllablesPerUtterance,
            hasCompleteSentences,
            hasWordFindingDifficulty,
            speechRate,
          }),
      };
    });

    // K-WAB 내용전달 점수(0~10): 질문 정반응(0~6) + 그림설명 요소수 기반 근사
    const goodCoverageCount = itemAnalyses.filter(
      (a) => a.keywordCoverage >= 0.2,
    ).length;
    const correctAnswers = Math.min(
      6,
      Math.round((goodCoverageCount / Math.max(1, items.length)) * 6),
    );
    const pictureDescriptionItems = itemAnalyses.reduce(
      (sum, a) => sum + a.uniqueHits,
      0,
    );
    const contentScore = scoreContentDelivery({
      correctAnswers,
      pictureDescriptionItems,
    });

    // K-WAB 유창성 점수(0~10): 대화/과제 수행 유창성 평균 근사
    const fluencyScore =
      itemAnalyses.reduce((sum, a) => sum + a.fluencyKwab, 0) /
      Math.max(1, itemAnalyses.length);

    return {
      contentScore: Math.max(0, Math.min(10, Number(contentScore || 0))),
      fluencyScore: Math.max(0, Math.min(10, Number(fluencyScore || 0))),
    };
  };

  const derivedKwab = useMemo<DerivedKwab | null>(() => {
    if (!sessionData) return null;
    const avg = (vals: number[]) =>
      vals.length ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
    const s1 = sessionData?.step1?.items || [];
    const s2 = sessionData?.step2?.items || [];
    const s3 = sessionData?.step3?.items || [];
    const s4 = sessionData?.step4?.items || [];
    const step1Accuracy = s1.length
      ? s1.filter((i: any) => i.isCorrect).length / s1.length
      : queryScores[1] / 20;
    const step3Accuracy = s3.length
      ? s3.filter((i: any) => i?.isCorrect).length / s3.length
      : Math.max(0, Math.min(1, Number(queryScores[3] || 0) / 100));
    const spontaneousSpeech = deriveSpontaneousSpeechFromStep4(s4);

    const scorePack = calculateKWABScores(
      {
        age: Number(loadPatientProfile()?.age ?? 65),
        educationYears: Number(loadPatientProfile()?.educationYears ?? 6),
      },
      {
        spontaneousSpeech,
        auditoryComprehension: {
          yesNoScore: Math.round(step1Accuracy * 60),
          // Step3(그림 매칭) 정확도를 낱말 인지 점수에 반영
          wordRecognitionScore: Math.round(step3Accuracy * 60),
          commandScore: Math.round(step1Accuracy * 80),
        },
        repetition: {
          totalScore: Math.max(
            0,
            Math.min(
              100,
              Math.round(
                avg(
                  s2.map((i: any) =>
                    Number(i?.finalScore ?? i?.speechScore ?? 0),
                  ),
                ) || queryScores[2],
              ),
            ),
          ),
        },
        naming: {
          objectNamingScore: 60,
          wordFluencyScore: 20,
          sentenceCompletionScore: 10,
          sentenceResponseScore: 10,
        },
        reading: { totalScore: 0 },
        writing: { totalScore: 0 },
      },
    );
    return { ...scorePack, aq: Number(scorePack.aq.toFixed(1)) } as any;
  }, [place, queryScores, sessionData]);

  const stepDetails = useMemo(() => {
    const clamp = (v: number, min = 0, max = 100) => Math.min(max, Math.max(min, v));
    const avg = (arr: number[]) =>
      arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
    const fmt1 = (v: number) => (Number.isInteger(v) ? String(v) : v.toFixed(1));

    const s1 = sessionData?.step1?.items || [];
    const s2 = sessionData?.step2?.items || [];
    const s3 = sessionData?.step3?.items || [];
    const s4 = sessionData?.step4?.items || [];
    const s5 = sessionData?.step5?.items || [];
    const s6 = sessionData?.step6?.items || [];

    const s1Correct = s1.filter((i: any) => i?.isCorrect).length;
    const s1Total = s1.length || 20;
    const s1Percent = s1.length
      ? clamp((s1Correct / s1.length) * 100)
      : clamp((queryScores[1] / 20) * 100);

    const s2Score = s2.length
      ? clamp(avg(s2.map((i: any) => Number(i?.finalScore ?? i?.speechScore ?? 0))))
      : clamp(queryScores[2]);

    const s3Correct = s3.filter((i: any) => i?.isCorrect).length;
    const s3Total = s3.length || 10;
    const s3Percent = s3.length
      ? clamp((s3Correct / s3.length) * 100)
      : clamp(queryScores[3]);

    const s4Score = s4.length
      ? Math.min(
          10,
          Math.max(0, avg(s4.map((i: any) => Number(i?.fluencyScore ?? i?.kwabScore ?? 0)))),
        )
      : Math.min(10, Math.max(0, Number(queryScores[4] || 0)));
    const s4Percent = clamp(s4Score * 10);

    const s5Percent = s5.length
      ? clamp(
          avg(
            s5.map((i: any) =>
              Number.isFinite(Number(i?.readingScore))
                ? Number(i?.readingScore)
                : i?.isCorrect
                  ? 100
                  : 0,
            ),
          ),
        )
      : clamp(queryScores[5]);

    const s6Correct = s6.filter((i: any) => i?.isCorrect).length;
    const s6Total = s6.length || 5;
    const s6Percent = s6.length
      ? clamp((s6Correct / s6.length) * 100)
      : clamp((queryScores[6] / 5) * 100);

    return [
      {
        id: 1,
        title: "청각 이해",
        display: `${s1Correct}/${s1Total}`,
        percent: s1Percent,
        metric: `${s1Correct}/${s1Total}`,
      },
      {
        id: 2,
        title: "따라말하기",
        display: `${Math.round(s2Score)}%`,
        percent: s2Score,
        metric: `${Math.round(s2Score)}%`,
      },
      {
        id: 3,
        title: "그림 매칭",
        display: `${s3Correct}/${s3Total}`,
        percent: s3Percent,
        metric: `${s3Correct}/${s3Total}`,
      },
      {
        id: 4,
        title: "유창성",
        display: `${fmt1(s4Score)}/10`,
        percent: s4Percent,
        metric: `${fmt1(s4Score)}/10`,
      },
      {
        id: 5,
        title: "읽기",
        display: `${Math.round(s5Percent)}%`,
        percent: s5Percent,
        metric: `${Math.round(s5Percent)}%`,
      },
      {
        id: 6,
        title: "쓰기",
        display: `${s6Correct}/${s6Total}`,
        percent: s6Percent,
        metric: `${s6Correct}/${s6Total}`,
      },
    ];
  }, [queryScores, sessionData]);

  const chartPoints = useMemo(() => {
    return stepDetails
      .map((d, i) => {
        const a = (Math.PI * 2 * i) / 6 - Math.PI / 2;
        const r = (Math.min(d.percent, 100) / 100) * 75;
        return `${100 + r * Math.cos(a)},${100 + r * Math.sin(a)}`;
      })
      .join(" ");
  }, [stepDetails]);

  const clinicalImpression = useMemo(() => {
    if (!derivedKwab) return null;
    const stepMap = Object.fromEntries(stepDetails.map((d) => [d.id, d])) as Record<
      number,
      (typeof stepDetails)[number]
    >;

    const comprehension = stepMap[1];
    const repetition = stepMap[2];
    const matching = stepMap[3];
    const fluency = stepMap[4];
    const reading = stepMap[5];
    const writing = stepMap[6];

    const domains = [
      { name: "청각 이해", percent: comprehension.percent, metric: comprehension.metric },
      { name: "따라말하기", percent: repetition.percent, metric: repetition.metric },
      { name: "그림 매칭", percent: matching.percent, metric: matching.metric },
      { name: "유창성", percent: fluency.percent, metric: fluency.metric },
      { name: "읽기", percent: reading.percent, metric: reading.metric },
      { name: "쓰기", percent: writing.percent, metric: writing.metric },
    ];
    const strongest = domains.reduce((a, b) => (a.percent >= b.percent ? a : b));
    const weakest = domains.reduce((a, b) => (a.percent <= b.percent ? a : b));

    const typeLabel = derivedKwab.aphasiaType || "비특이적 실어증";
    const aqLabel =
      derivedKwab.aq >= 75
        ? "경도 수준의 의사소통 어려움"
        : derivedKwab.aq >= 50
          ? "중등도 수준의 의사소통 어려움"
          : "중등도-중증 수준의 의사소통 어려움";

    return {
      summary: `[평가 요약]\n${typeLabel} 양상이 관찰되며 AQ ${derivedKwab.aq}점으로 ${aqLabel}이 시사됩니다.\n\n[세부 결과]\n청각 이해 ${comprehension.metric} · 따라말하기 ${repetition.metric} · 그림 매칭 ${matching.metric}\n유창성 ${fluency.metric} · 읽기 ${reading.metric} · 쓰기 ${writing.metric}`,
      strength: `${strongest.name}(${strongest.metric}) 영역은 상대적으로 보존되어 구조화된 단서 제공 시 과제 수행 안정성이 확인됩니다.`,
      need: `${weakest.name}(${weakest.metric}) 영역의 저하가 두드러져, 단문 산출→반복→확장 순서의 단계적 언어치료가 우선 권장됩니다.`,
      recommendation:
        "가정에서는 기능어·핵심어를 포함한 1~2문장 말하기 훈련을 하루 15~20분, 주 5회 이상 시행하고, 치료실에서는 저하 영역 중심으로 과제 난이도를 점진적으로 상향하는 중재를 권장합니다.",
      aqText: `${derivedKwab.aq}점 (${aqLabel})`,
      strongestText: `${strongest.name} ${strongest.metric}`,
      weakestText: `${weakest.name} ${weakest.metric}`,
    };
  }, [derivedKwab, stepDetails]);

  const formattedClinicalImpression = useMemo(() => {
    if (!clinicalImpression) return null;
    return {
      ...clinicalImpression,
      summary: addSentenceLineBreaks(clinicalImpression.summary),
      strength: addSentenceLineBreaks(clinicalImpression.strength),
      need: addSentenceLineBreaks(clinicalImpression.need),
      recommendation: addSentenceLineBreaks(clinicalImpression.recommendation),
    };
  }, [clinicalImpression]);

  const normalComparison = useMemo(() => {
    if (!derivedKwab) return null;
    const age = Number((patientProfile as any)?.age ?? 65);
    const educationYears = Number((patientProfile as any)?.educationYears ?? 6);
    return getAQNormalComparison(derivedKwab.aq, age, educationYears);
  }, [derivedKwab, patientProfile]);

  const previousHistory = useMemo(() => {
    if (!patientForHistory) return [];
    const all = SessionManager.getHistoryFor(patientForHistory)
      .filter((row) => row.place === place)
      .sort((a, b) => b.completedAt - a.completedAt);

    return all.length > 1 ? all.slice(1) : [];
  }, [historyRefreshKey, patientForHistory, place]);

  const aqSeverityLabel = (aq: number) => {
    if (aq >= 93.8) return "정상 범위";
    if (aq >= 76) return "경도";
    if (aq >= 51) return "중등도";
    if (aq >= 26) return "중증";
    return "최중증";
  };
  const HISTORY_PAGE_SIZE = 4;
  const historyTotalPages = Math.max(
    1,
    Math.ceil(previousHistory.length / HISTORY_PAGE_SIZE),
  );
  const pagedHistory = useMemo(() => {
    const start = (historyPage - 1) * HISTORY_PAGE_SIZE;
    return previousHistory.slice(start, start + HISTORY_PAGE_SIZE);
  }, [historyPage, previousHistory]);

  useEffect(() => {
    if (historyPage > historyTotalPages) {
      setHistoryPage(historyTotalPages);
    }
  }, [historyPage, historyTotalPages]);

  useEffect(() => {
    if (
      selectedHistory &&
      !previousHistory.some((row) => row.historyId === selectedHistory.historyId)
    ) {
      setSelectedHistory(null);
    }
  }, [previousHistory, selectedHistory]);

  useEffect(() => {
    if (!patientForHistory) return;
    const all = SessionManager.getHistoryFor(patientForHistory).filter(
      (row) => row.place === place,
    );
    // 이전기록 페이지네이션(4개 초과) 확인을 위해 최소 6개(현재 1 + 이전 5) 보장
    if (all.length < 6) {
      const need = 6 - all.length;
      const inserted = SessionManager.seedMockHistoryFor(patientForHistory, place, need);
      if (inserted > 0) {
        setHistoryRefreshKey((v) => v + 1);
      }
    }
  }, [patientForHistory, place]);

  const parseStoredArray = (key: string) => {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  };

  // --- 데이터 불러오기 및 내보내기 로직 (보존) ---
  useEffect(() => {
    setIsMounted(true);
    const backups = {
      step1: parseStoredArray("step1_data"),
      step2: parseStoredArray("step2_recorded_audios"),
      step3: parseStoredArray("step3_data"),
      step4: parseStoredArray("step4_recorded_audios"),
      step5: parseStoredArray("step5_recorded_data"),
      step6: parseStoredArray("step6_recorded_data"),
    };
    setSessionData({
      step1: { items: backups.step1 },
      step2: { items: backups.step2 },
      step3: { items: backups.step3 },
      step4: { items: backups.step4 },
      step5: { items: backups.step5 },
      step6: { items: backups.step6 },
    });
    console.debug("[Result] backups loaded", {
      step1: backups.step1.length,
      step2: backups.step2.length,
      step3: backups.step3.length,
      step4: backups.step4.length,
      step5: backups.step5.length,
      step6: backups.step6.length,
    });
  }, []);

  const handleExportData = () => {
    if (!sessionData) return;
    const patient = loadPatientProfile();
    const exportPayload = {
      exportedAt: new Date().toISOString(),
      patient,
      summaryScores: stepDetails,
      details: sessionData,
    };
    const files: ExportFile[] = [
      {
        name: "result.json",
        data: new TextEncoder().encode(JSON.stringify(exportPayload, null, 2)),
      },
    ];

    // 오디오/이미지 백업 로직 포함
    const zipBlob = createZipBlob(files);
    const url = URL.createObjectURL(zipBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `report-${patient?.name || "patient"}.zip`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const playAudio = (url: string, id: string) => {
    if (playingIndex === id) {
      audioRef.current?.pause();
      setPlayingIndex(null);
      return;
    }
    audioRef.current = new Audio(url);
    audioRef.current.play();
    setPlayingIndex(id);
    audioRef.current.onended = () => setPlayingIndex(null);
  };

  if (!isMounted || !sessionData) return null;

  return (
    <>
      <style jsx global>{`
        @page {
          size: A4 portrait;
          margin: 4mm;
        }
        @media print {
          body {
            background: white !important;
            font-size: 8.5pt !important;
            line-height: 1.2 !important;
          }
          .no-print {
            display: none !important;
          }
          .print-only {
            display: block !important;
          }
          .print-container {
            width: auto;
            max-width: none;
            padding: 0;
            margin: 0 auto;
            box-shadow: none !important;
            gap: 1.5mm !important;
          }
          section {
            page-break-inside: avoid;
            border: 1px solid #eee !important;
            border-radius: 10px !important;
            margin-bottom: 1.5mm !important;
            padding: 7px !important;
          }
          header {
            border-bottom: 1px solid #cbd5e1 !important;
            padding: 7px !important;
            margin-bottom: 1.5mm !important;
          }
          .print-header h2 {
            font-size: 13px !important;
          }
          .print-top-grid {
            grid-template-columns: 1fr !important;
            gap: 1.5mm !important;
          }
          .profile-chart {
            width: 95px !important;
            height: 95px !important;
          }
          .profile-body {
            display: grid !important;
            grid-template-columns: 110px 1fr !important;
            gap: 8px !important;
            align-items: center !important;
          }
          .profile-chart-wrap {
            margin: 0 !important;
            justify-content: center !important;
          }
          .profile-metrics {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 4px 8px !important;
          }
          .profile-metric-item {
            background: transparent !important;
            border: none !important;
            border-left: 2px solid #fed7aa !important;
            border-radius: 0 !important;
            padding: 2px 0 2px 6px !important;
            align-items: flex-start !important;
            text-align: left !important;
          }
          .profile-metric-item .metric-title {
            font-size: 9px !important;
            margin-bottom: 1px !important;
          }
          .profile-metric-item .metric-value {
            font-size: 10.5px !important;
          }
          .patient-meta-grid {
            grid-template-columns: repeat(3, minmax(0, 1fr)) 140px !important;
            gap: 3px !important;
          }
          .aq-card {
            grid-column: 4 !important;
            grid-row: 1 / span 2 !important;
            min-width: 140px !important;
            padding: 6px 8px !important;
          }
          .normal-compare-card {
            grid-column: 1 / span 3 !important;
            grid-row: 2 !important;
          }
          .aq-card .aq-value {
            font-size: 20px !important;
          }
          .impression-content {
            gap: 4px !important;
          }
          .impression-content p {
            margin: 0 !important;
          }
          .print-history-list .history-row {
            padding: 4px 6px !important;
          }
          .print-history-list .history-row p {
            font-size: 9px !important;
            line-height: 1.15 !important;
          }
        }
        .print-only {
          display: none;
        }
        .custom-scroll::-webkit-scrollbar {
          width: 5px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
          background: #e2e8f0;
          border-radius: 10px;
        }
      `}</style>

      <div className="min-h-screen bg-[#F8FAFC] text-[#0f172a] pb-12 font-sans">
        {/* 상단바 */}
        <nav className="no-print bg-white/90 backdrop-blur-md sticky top-0 z-50 border-b border-orange-100 px-6 h-14 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center">
              <span className="text-white font-black text-xs italic">L</span>
            </div>
            <h1 className="font-black text-sm tracking-tighter text-slate-900 uppercase">
              Diagnosis Report
            </h1>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => router.push("/")}
              className="px-4 py-2 bg-white text-slate-900 border border-orange-200 rounded-xl text-xs font-bold shadow-sm hover:bg-orange-50 active:scale-95 transition-all"
            >
              처음으로
            </button>
            <button
              onClick={handleExportData}
              className="px-4 py-2 bg-white text-slate-900 border border-orange-200 rounded-xl text-xs font-bold shadow-sm hover:bg-orange-50 active:scale-95 transition-all"
            >
              데이터 백업
            </button>
            <button
              onClick={() => window.print()}
              className="px-4 py-2 bg-orange-500 text-white rounded-xl text-xs font-bold shadow-sm hover:bg-orange-600 active:scale-95 transition-all"
            >
              진단서 출력 (PDF)
            </button>
          </div>
        </nav>

        <main className="max-w-5xl mx-auto px-6 py-8 space-y-4 print-container">
          {/* [HEADER] 공식 진단서 스타일 */}
          <header className="bg-white rounded-2xl p-4 md:p-5 border border-slate-300 shadow-sm relative overflow-hidden print-card print-header">
            <div className="absolute top-0 left-0 w-2 h-full bg-slate-900 no-print" />
            <div className="space-y-3 text-left w-full min-w-0">
              <h2 className="text-lg font-black text-slate-900 tracking-tight">
                종합 언어 진단 리포트
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-[repeat(3,minmax(0,1fr))_280px] gap-2 patient-meta-grid">
                <div className="bg-white border border-slate-300 rounded-xl px-3 py-2">
                  <p className="text-[10px] font-bold text-slate-700">성함</p>
                  <p className="text-[14px] font-black text-slate-900 leading-tight">
                    {loadPatientProfile()?.name || "미입력"}
                  </p>
                </div>
                <div className="bg-white border border-slate-300 rounded-xl px-3 py-2">
                  <p className="text-[10px] font-bold text-slate-700">연령</p>
                  <p className="text-[14px] font-black text-slate-900 leading-tight">
                    {loadPatientProfile()?.age || "-"}세
                  </p>
                </div>
                <div className="bg-white border border-slate-300 rounded-xl px-3 py-2">
                  <p className="text-[10px] font-bold text-slate-700">교육</p>
                  <p className="text-[14px] font-black text-slate-900 leading-tight">
                    {loadPatientProfile()?.educationYears || "-"}년
                  </p>
                </div>
                <div className="md:col-start-4 md:row-start-1 md:row-end-3 text-center bg-slate-900 rounded-xl px-4 py-2 text-white shadow-sm w-full aq-card">
                  <p className="text-[10px] font-black opacity-80 uppercase tracking-widest mb-0.5">
                    Diagnostic Score (AQ)
                  </p>
                  <div className="flex items-baseline justify-center gap-1">
                    <span className="text-2xl font-black leading-none aq-value">
                      {derivedKwab?.aq || "0.0"}
                    </span>
                    <span className="text-xs font-bold opacity-60">/ 100</span>
                  </div>
                  <p className="mt-1 text-[10px] font-black uppercase bg-white/20 py-0.5 rounded-full">
                    {derivedKwab?.aphasiaType || "유형 분석 중"}
                  </p>
                </div>
                <div className="normal-compare-card md:col-start-1 md:col-span-3 md:row-start-2 rounded-xl border border-slate-900 bg-slate-900 px-3 py-2 text-center">
                  <p className="text-[11px] font-black text-white tracking-wide">
                    {normalComparison
                      ? `정상군 평균 ${normalComparison.mean.toFixed(2)} (SD ${normalComparison.sd.toFixed(2)}) / 대비 ${normalComparison.diff >= 0 ? "+" : ""}${normalComparison.diff.toFixed(1)}`
                      : "정상군 기준 계산 불가"}
                  </p>
                </div>
              </div>
            </div>
          </header>

          <div className="grid grid-cols-1 md:grid-cols-[360px_1fr] gap-4 items-stretch print-top-grid">
            {/* [01] 역량 차트 */}
            <section className="bg-white rounded-2xl p-5 border border-orange-200 shadow-sm h-full profile-section">
              <h3 className="text-lg font-black text-slate-900 border-l-4 border-orange-500 pl-3 mb-5 uppercase tracking-wider">
                01. 언어 기능 프로파일
              </h3>
              <div className="profile-body">
                <div className="flex justify-center mb-5 profile-chart-wrap">
                  <svg viewBox="0 0 200 200" className="w-48 h-48 profile-chart">
                    {[0.25, 0.5, 0.75, 1].map((st) => (
                      <polygon
                        key={st}
                        points={stepDetails
                          .map((_, i) => {
                            const a = (Math.PI * 2 * i) / 6 - Math.PI / 2;
                            return `${100 + 75 * st * Math.cos(a)},${100 + 75 * st * Math.sin(a)}`;
                          })
                          .join(" ")}
                        fill="none"
                        stroke="#F1F5F9"
                        strokeWidth="2"
                      />
                    ))}
                    <polygon
                      points={chartPoints}
                      fill="rgba(139, 69, 19, 0.15)"
                      stroke="#F97316"
                      strokeWidth="4"
                      strokeLinejoin="round"
                    />
                  </svg>
                </div>
                <div className="grid grid-cols-2 gap-2 profile-metrics">
                  {stepDetails.map((d) => (
                    <div
                      key={d.id}
                      className="bg-orange-50/70 p-2.5 rounded-lg flex flex-col items-center border border-orange-100 profile-metric-item"
                    >
                      <p className="text-[10px] font-black text-slate-700 mb-0.5 metric-title">
                        {d.title}
                      </p>
                      <p className="text-base font-black text-slate-900 leading-none metric-value">
                        {d.display}
                      </p>
                    </div>
                  ))}
                </div>
              </div>
            </section>

            {/* [02] 소견서 */}
            <section className="bg-white rounded-2xl p-5 border border-orange-200 shadow-sm h-full">
              <h3 className="text-lg font-black text-slate-900 border-l-4 border-orange-500 pl-3 mb-4 pb-2 border-b border-orange-100 uppercase tracking-wider">
                02. 전문가 임상 소견
              </h3>

              <div className="bg-orange-50/40 border border-orange-200 rounded-xl p-4 space-y-3 impression-content">
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                  <div className="rounded-lg border border-orange-200 bg-white px-3 py-2">
                    <p className="text-[10px] font-black text-slate-600">종합 해석</p>
                    <p className="text-[11px] font-black text-slate-800">
                      {clinicalImpression?.aqText}
                    </p>
                  </div>
                  <div className="rounded-lg border border-emerald-200 bg-white px-3 py-2">
                    <p className="text-[10px] font-black text-slate-600">상대적 강점</p>
                    <p className="text-[11px] font-black text-emerald-600">
                      {clinicalImpression?.strongestText}
                    </p>
                  </div>
                  <div className="rounded-lg border border-sky-200 bg-white px-3 py-2">
                    <p className="text-[10px] font-black text-slate-600">집중 중재 영역</p>
                    <p className="text-[11px] font-black text-sky-700">
                      {clinicalImpression?.weakestText}
                    </p>
                  </div>
                </div>

                <p
                  className={`${getResultSummarySizeClass(formattedClinicalImpression?.summary || "")} font-black text-slate-800 leading-relaxed whitespace-pre-line`}
                >
                  {formattedClinicalImpression?.summary}
                </p>
                <p className="text-[11px] font-bold text-slate-600 leading-relaxed whitespace-pre-line">
                  상대적 강점: {formattedClinicalImpression?.strength}
                </p>
                <p className="text-[11px] font-bold text-slate-600 leading-relaxed whitespace-pre-line">
                  집중 훈련: {formattedClinicalImpression?.need}
                </p>
                <p className="text-[11px] font-bold text-slate-600 leading-relaxed whitespace-pre-line">
                  훈련 권장사항: {formattedClinicalImpression?.recommendation}
                </p>
              </div>
            </section>
          </div>

          <section className="no-print bg-white rounded-2xl p-5 border border-orange-200 shadow-sm">
            <div className="flex items-center justify-between mb-4 border-b border-slate-100 pb-3">
              <h3 className="text-lg font-black text-slate-900 border-l-4 border-orange-500 pl-3 uppercase tracking-wider">
                이전 기록
              </h3>
              <div className="flex items-center gap-2">
                <p className="text-[11px] font-bold text-slate-600">
                  총 {previousHistory.length}건
                </p>
                <button
                  onClick={() => setSelectedHistory(null)}
                  className="px-2.5 py-1 rounded-lg border border-orange-200 bg-white text-[10px] font-black text-slate-700 hover:bg-orange-50"
                >
                  현재 기록 보기
                </button>
              </div>
            </div>

            {previousHistory.length === 0 ? (
              <div className="h-20 rounded-xl border border-dashed border-orange-200 bg-orange-50/70 flex items-center justify-center text-[11px] font-bold text-slate-700">
                비교할 이전 기록이 없습니다.
              </div>
            ) : (
              <div className="space-y-3">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {pagedHistory.map((row) => (
                    <button
                      key={row.historyId}
                      onClick={() => setSelectedHistory(row)}
                      className={`text-left rounded-xl border p-3 space-y-2 transition-colors ${
                        selectedHistory?.historyId === row.historyId
                          ? "border-orange-300 bg-orange-50/50"
                          : "border-slate-200 bg-slate-50 hover:bg-slate-100"
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <p className="text-[11px] font-black text-slate-700">
                          {new Date(row.completedAt).toLocaleString("ko-KR")}
                        </p>
                        <p className="text-[11px] font-black text-slate-800">
                          AQ {row.aq}
                        </p>
                      </div>
                      <div className="grid grid-cols-3 gap-1 text-[10px] font-bold text-slate-500">
                        <span>청각 {row.stepScores.step1}%</span>
                        <span>따라말 {row.stepScores.step2}%</span>
                        <span>매칭 {row.stepScores.step3}%</span>
                        <span>유창 {row.stepScores.step4}%</span>
                        <span>읽기 {row.stepScores.step5}%</span>
                        <span>쓰기 {row.stepScores.step6}%</span>
                      </div>
                    </button>
                  ))}
                </div>

                {previousHistory.length > HISTORY_PAGE_SIZE && (
                  <div className="flex items-center justify-center gap-1.5 pt-1">
                    <button
                      onClick={() => setHistoryPage((p) => Math.max(1, p - 1))}
                      disabled={historyPage === 1}
                      className="px-2 py-1 rounded-md border border-slate-200 text-[10px] font-black text-slate-600 disabled:opacity-40"
                    >
                      이전
                    </button>
                    {Array.from({ length: historyTotalPages }).map((_, i) => {
                      const page = i + 1;
                      return (
                        <button
                          key={`history-page-${page}`}
                          onClick={() => setHistoryPage(page)}
                          className={`w-7 h-7 rounded-md text-[10px] font-black border ${
                            historyPage === page
                              ? "bg-slate-900 text-white border-slate-900"
                              : "bg-white text-slate-600 border-slate-200"
                          }`}
                        >
                          {page}
                        </button>
                      );
                    })}
                    <button
                      onClick={() =>
                        setHistoryPage((p) => Math.min(historyTotalPages, p + 1))
                      }
                      disabled={historyPage === historyTotalPages}
                      className="px-2 py-1 rounded-md border border-slate-200 text-[10px] font-black text-slate-600 disabled:opacity-40"
                    >
                      다음
                    </button>
                  </div>
                )}
              </div>
            )}
          </section>

          <section className="print-only bg-white rounded-2xl p-5 border border-orange-200 shadow-sm print-history-list">
            <div className="flex items-center justify-between mb-4 border-b border-slate-100 pb-3">
              <h3 className="text-lg font-black text-slate-900 border-l-4 border-orange-500 pl-3 uppercase tracking-wider">
                03. 이전 기록 진단 리스트
              </h3>
              <p className="text-[11px] font-bold text-slate-600">
                총 {previousHistory.length}건
              </p>
            </div>

            {previousHistory.length === 0 ? (
              <div className="rounded-lg border border-dashed border-slate-200 p-3 text-[11px] font-bold text-slate-600">
                이전 기록 없음
              </div>
            ) : (
              <div className="space-y-1.5">
                {previousHistory.slice(0, 4).map((row, index) => (
                  <div
                    key={`print-history-${row.historyId}`}
                    className="history-row rounded-lg border border-slate-200 bg-slate-50 px-3 py-2"
                  >
                    <div className="flex items-center justify-between text-[11px] font-black text-slate-700">
                      <span>
                        {index + 1}. {new Date(row.completedAt).toLocaleDateString("ko-KR")}
                      </span>
                      <span className="text-slate-800">AQ {row.aq}</span>
                    </div>
                    <p className="mt-1 text-[10px] font-bold text-slate-500">
                      중증도: {aqSeverityLabel(row.aq)} · 청각 {row.stepScores.step1}% · 따라말
                      {row.stepScores.step2}% · 매칭 {row.stepScores.step3}% · 유창{" "}
                      {row.stepScores.step4}% · 읽기 {row.stepScores.step5}% · 쓰기{" "}
                      {row.stepScores.step6}%
                    </p>
                  </div>
                ))}
              </div>
            )}
          </section>

          {selectedHistory && (
            <section className="no-print bg-white rounded-2xl p-5 border border-orange-200 shadow-sm">
              <div className="flex items-center justify-between mb-6 border-b border-slate-100 pb-4">
                <div className="space-y-1">
                  <h3 className="text-lg font-black text-slate-900 border-l-4 border-orange-500 pl-3 uppercase tracking-wider">
                    이전 기록 상세
                  </h3>
                  <p className="text-xs font-bold text-slate-600">
                    {new Date(selectedHistory.completedAt).toLocaleString("ko-KR")} · AQ{" "}
                    {selectedHistory.aq}
                  </p>
                </div>
              </div>

              <div className="space-y-3">
                {stepDetails.map((step) => {
                  const key = `step${step.id}` as keyof TrainingHistoryEntry["stepDetails"];
                  const items = selectedHistory.stepDetails?.[key] || [];
                  const isOpen = openAllAccordions || openStepId === step.id;
                  return (
                    <div
                      key={`history-${selectedHistory.historyId}-${step.id}`}
                      className="bg-slate-50/50 rounded-xl border border-slate-100 overflow-hidden"
                    >
                      <button
                        onClick={() => {
                          if (openAllAccordions) {
                            setOpenAllAccordions(false);
                            setOpenStepId(step.id);
                            return;
                          }
                          setOpenStepId(isOpen ? null : step.id);
                        }}
                        className="w-full px-4 py-3 bg-white flex items-center justify-between text-left border-b border-slate-100"
                      >
                        <div className="flex items-center gap-2">
                          <span className="text-[10px] font-black text-orange-500 bg-orange-50 px-2 py-0.5 rounded-full uppercase tracking-widest">
                            Step 0{step.id}
                          </span>
                          <span className="text-xs font-black text-slate-800">
                            {step.title}
                          </span>
                        </div>
                        <div className="flex items-center gap-3">
                          <span className="text-[10px] font-black text-slate-600">
                            {items.length} Activities
                          </span>
                          <span className="text-slate-600 text-[10px] font-black">
                            {isOpen ? "▲" : "▼"}
                          </span>
                        </div>
                      </button>

                      {isOpen && (
                        <div
                          className={`grid gap-2 p-3 ${
                            items.length === 3
                              ? "grid-cols-1 sm:grid-cols-2 md:grid-cols-3"
                              : "grid-cols-1 sm:grid-cols-2 md:grid-cols-5"
                          }`}
                        >
                          {items.length === 0 ? (
                            <div className="col-span-full h-20 flex items-center justify-center italic text-[10px] text-slate-300 font-bold border border-dashed border-slate-200 rounded-xl">
                              No Data Recorded
                            </div>
                          ) : (
                            items.map((it: any, i: number) => (
                              <div
                                key={i}
                                className="group bg-white p-3 rounded-lg border border-slate-200/60 shadow-sm hover:border-orange-200 transition-all"
                              >
                                <div className="flex justify-between items-center mb-2">
                                  <span className="text-[9px] font-black text-slate-300 uppercase">
                                    Index {i + 1}
                                  </span>
                                  <div
                                    className={`px-1.5 py-0.5 rounded text-[8px] font-black ${it.isCorrect ? "bg-emerald-50 text-emerald-500" : "bg-orange-50 text-orange-700"}`}
                                  >
                                    {it.isCorrect ? "CORRECT" : "REVIEW"}
                                  </div>
                                </div>

                                {step.id === 6 && it.userImage && (
                                  <div className="aspect-video bg-slate-50 rounded-md mb-2 overflow-hidden border border-slate-100 flex items-center justify-center">
                                    <img
                                      src={it.userImage}
                                      className="max-h-full max-w-full object-contain p-2"
                                      alt="history-training-result"
                                    />
                                  </div>
                                )}

                                <p className="text-xs font-bold text-slate-600 leading-snug mb-2">
                                  "{it.text || it.targetText || it.targetWord || "..."}"
                                </p>

                                {it.audioUrl && (
                                  <button
                                    onClick={() =>
                                      playAudio(
                                        it.audioUrl,
                                        `h-${selectedHistory.historyId}-s${step.id}-${i}`,
                                      )
                                    }
                                    className={`w-full py-1.5 rounded-md text-[10px] font-black flex items-center justify-center gap-2 transition-all ${playingIndex === `h-${selectedHistory.historyId}-s${step.id}-${i}` ? "bg-slate-900 text-white shadow-sm" : "bg-slate-50 text-slate-600 group-hover:bg-orange-50 group-hover:text-slate-900"}`}
                                  >
                                    {playingIndex ===
                                    `h-${selectedHistory.historyId}-s${step.id}-${i}` ? (
                                      <>
                                        <span>■</span> STOP SOUND
                                      </>
                                    ) : (
                                      <>
                                        <span>▶</span> PLAY SOUND
                                      </>
                                    )}
                                  </button>
                                )}
                              </div>
                            ))
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </section>
          )}

          <section className="no-print bg-white rounded-2xl p-5 border border-orange-200 shadow-sm">
            <div className="flex items-center justify-between mb-6 border-b border-slate-100 pb-4">
              <div className="space-y-1">
                <h3 className="text-lg font-black text-slate-900 border-l-4 border-orange-500 pl-3 uppercase tracking-wider">
                  03. 수행 기록 상세
                </h3>
                <p className="text-xs font-bold text-slate-600">
                  단계별 항목을 펼쳐 상세 기록을 확인하세요.
                </p>
              </div>
              <button
                onClick={() => setOpenAllAccordions((prev) => !prev)}
                className="px-3 py-1.5 rounded-xl border border-slate-200 bg-white text-[11px] font-black text-slate-600 hover:bg-slate-50 transition-colors"
              >
                {openAllAccordions ? "전체닫기" : "전체보기"}
              </button>
            </div>

            <div className="space-y-3">
              {stepDetails.map((step) => {
                const items = sessionData[`step${step.id}`]?.items || [];
                const isOpen = openAllAccordions || openStepId === step.id;
                return (
                  <div
                    key={step.id}
                    className="bg-slate-50/50 rounded-xl border border-slate-100 overflow-hidden"
                  >
                    <button
                      onClick={() => {
                        if (openAllAccordions) {
                          setOpenAllAccordions(false);
                          setOpenStepId(step.id);
                          return;
                        }
                        setOpenStepId(isOpen ? null : step.id);
                      }}
                      className="w-full px-4 py-3 bg-white flex items-center justify-between text-left border-b border-slate-100"
                    >
                      <div className="flex items-center gap-2">
                        <span className="text-[10px] font-black text-orange-500 bg-orange-50 px-2 py-0.5 rounded-full uppercase tracking-widest">
                          Step 0{step.id}
                        </span>
                        <span className="text-xs font-black text-slate-800">
                          {step.title}
                        </span>
                      </div>
                      <div className="flex items-center gap-3">
                        <span className="text-[10px] font-black text-slate-600">
                          {items.length} Activities
                        </span>
                        <span className="text-slate-600 text-[10px] font-black">
                          {isOpen ? "▲" : "▼"}
                        </span>
                      </div>
                    </button>

                    {isOpen && (
                      <div
                        className={`grid gap-2 p-3 ${
                          items.length === 3
                            ? "grid-cols-1 sm:grid-cols-2 md:grid-cols-3"
                            : "grid-cols-1 sm:grid-cols-2 md:grid-cols-5"
                        }`}
                      >
                        {items.length === 0 ? (
                          <div className="col-span-full h-20 flex items-center justify-center italic text-[10px] text-slate-300 font-bold border border-dashed border-slate-200 rounded-xl">
                            No Data Recorded
                          </div>
                        ) : (
                          items.map((it: any, i: number) => (
                            <div
                              key={i}
                              className="group bg-white p-3 rounded-lg border border-slate-200/60 shadow-sm hover:border-orange-200 transition-all"
                            >
                              <div className="flex justify-between items-center mb-2">
                                <span className="text-[9px] font-black text-slate-300 uppercase">
                                  Index {i + 1}
                                </span>
                                <div
                                  className={`px-1.5 py-0.5 rounded text-[8px] font-black ${it.isCorrect ? "bg-emerald-50 text-emerald-500" : "bg-orange-50 text-orange-700"}`}
                                >
                                  {it.isCorrect ? "CORRECT" : "REVIEW"}
                                </div>
                              </div>

                              {step.id === 6 && it.userImage && (
                                <div className="aspect-video bg-slate-50 rounded-md mb-2 overflow-hidden border border-slate-100 flex items-center justify-center">
                                  <img
                                    src={it.userImage}
                                    className="max-h-full max-w-full object-contain p-2"
                                    alt="training-result"
                                  />
                                </div>
                              )}

                              <p className="text-xs font-bold text-slate-600 leading-snug mb-2">
                                "{it.text || it.targetText || it.targetWord || "..."}"
                              </p>

                              {it.audioUrl && (
                                <button
                                  onClick={() =>
                                    playAudio(it.audioUrl, `s${step.id}-${i}`)
                                  }
                                  className={`w-full py-1.5 rounded-md text-[10px] font-black flex items-center justify-center gap-2 transition-all ${playingIndex === `s${step.id}-${i}` ? "bg-slate-900 text-white shadow-sm" : "bg-slate-50 text-slate-600 group-hover:bg-orange-50 group-hover:text-slate-900"}`}
                                >
                                  {playingIndex === `s${step.id}-${i}` ? (
                                    <>
                                      <span>■</span> STOP SOUND
                                    </>
                                  ) : (
                                    <>
                                      <span>▶</span> PLAY SOUND
                                    </>
                                  )}
                                </button>
                              )}
                            </div>
                          ))
                        )}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </section>

        </main>
      </div>
    </>
  );
}

export default function ResultPage() {
  return (
    <Suspense fallback={<div>LOADING...</div>}>
      <ResultContent />
    </Suspense>
  );
}
